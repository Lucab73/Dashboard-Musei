<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèõÔ∏è Dashboard Settore Musei Civici Bologna</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- Leaflet per le mappe interattive -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.min.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        
        .header h1 {
            font-size: 4rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .header h2 {
            font-size: 2.5rem;
            margin-top: 40px;
            margin-bottom: 10px;
            color: #333;
        }

        .header p {
            color: #666;
            font-size: 1.6rem;
            font-style: italic;
        }
        .percentage-cell.positive {
            color: #2c7a7b; /* verde/teal scuro, neutro positivo */
        }

        .percentage-cell.negative {
             color: #c53030; /* rosso */
        }
        .chart-note {
            text-align: center;
            font-style: italic;
            color: #333;
            margin-top: 10px; /* Sposta la didascalia 10px sotto il grafico */
            padding-bottom: 10px;
            font-size: 1.3rem;
            background: rgba(255,255,255,0.7);
            border-radius: 10px; /* Arrotonda tutti gli angoli */
            padding-top: 10px;
        }

.summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    border-radius: 12px;
    overflow: hidden;
    background: white;
    margin: 20px 0;
}
.summary-table thead {
    background: #4a3fa5; /* colore piatto, scuro, accessibile */
    color: white;
}
.summary-table thead th {
    padding: 16px 12px;
    text-align: center;
    font-weight: bold;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: none;
}
.summary-table thead th:first-child {
    text-align: left;
    border-top-left-radius: 12px;
}
.summary-table thead th:last-child {
    border-top-right-radius: 12px;
}
.summary-table tbody tr {
    transition: all 0.2s ease;
}
.summary-table tbody tr:nth-child(even) {
    background-color: #f8f9fa;
}
.summary-table tbody tr:hover {
    background: rgba(102, 126, 234, 0.06);
    transform: none;
    box-shadow: none;
}
.summary-table tbody td {
    padding: 14px 12px;
    border: none;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
}
.summary-table tbody td:first-child {
    font-weight: 700;
    font-size: 1.1rem;
    color: #1a252f;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    border-radius: 0 8px 8px 0; /* angoli arrotondati (opzionale) */
}
.summary-table .numeric-cell {
    text-align: right;
    font-family: 'SF Pro Display', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    font-weight: 600;
    font-size: 1.05rem;
    color: #1a202c;
    letter-spacing: 0.3px;
}
.summary-table .percentage-cell {
    text-align: right;
    font-family: 'SF Pro Display', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    font-weight: 700;
    font-size: 1.05rem;
    letter-spacing: 0.3px;
}
/* Righe speciali */
.summary-table .total-row {
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(155, 89, 182, 0.1) 100%) !important;
    font-weight: bold;
    border-top: 2px solid #3498db;
}
.summary-table .total-row td {
    padding: 16px 12px;
    color: #2c3e50;
    font-size: 1.05rem;
}
.summary-table .total-row td:first-child {
    font-size: 1.15rem;
    font-weight: 800;
}
.summary-table .total-row .numeric-cell,
.summary-table .total-row .percentage-cell {
    font-size: 1.1rem;
    font-weight: 700;
}
.summary-table .percentage-row {
    background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, rgba(52, 152, 219, 0.1) 100%) !important;
    font-weight: bold;
    font-style: italic;
}
.summary-table .percentage-row td {
    padding: 12px;
    color: #27ae60;
}
.summary-table .percentage-row td:first-child {
    font-size: 1.1rem;
    font-weight: 700;
}
.summary-table .percentage-row .numeric-cell,
.summary-table .percentage-row .percentage-cell {
    font-size: 1.05rem;
    font-weight: 700;
    color: #27ae60;
}
/* Contenitore tabella */
.table-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin: 20px 0;
    overflow-x: auto;
}

.table-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #000000 !important;  /* Forza il colore nero */
    margin-bottom: 20px;
    text-align: center;
    background: none !important;  /* Rimuovi qualsiasi background */
    -webkit-text-fill-color: #000000 !important;  /* Forza il colore anche per webkit */
    
}
       
        /* === INIZIO BLOCCO STILI TAB AGGIORNATO === */
        /* Stili per le schede (Tabs) - NUOVA VERSIONE */
        .tab-buttons {
    display: flex;
    justify-content: flex-start;
    border-bottom: 2px solid #e0e0e0;
    margin-bottom: 0;
    padding-left: 15px;
    background-color: #f8f9fa; /* Sfondo leggermente grigio per l'area delle tab */
}

.tab-buttons button {
    border: 2px solid #e0e0e0;
    border-bottom: none; /* Rimuove il bordo inferiore per l'effetto linguetta */
    background: #ffffff; /* Sfondo bianco per le tab */
    color: #666;
    font-size: 1.4rem;
    font-weight: 500;
    padding: 12px 24px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-right: 4px; /* Spazio tra le tab */
    border-radius: 8px 8px 0 0; /* Angoli arrotondati solo in alto */
    position: relative;
    z-index: 1;
    box-shadow: 0 -2px 4px rgba(0,0,0,0.1); /* Ombra sottile per dare profondit√† */
    overflow: hidden;
}
.tab-buttons button::after {
  content: '';
  position: absolute;
  width: 100%;
  height: 0%;
  bottom: 0;
  left: 0;
  background-color: rgba(255, 255, 255, 0.3);
  transition: height 0.3s ease;
  z-index: 0;
}
.tab-buttons button:hover::after {
  height: 100%;
}
.tab-buttons button:hover {
    background-color: #f0f4ff;
    color: #667eea;
    transform: translateY(-2px); /* Leggero sollevamento al hover */
    box-shadow: 0 -4px 8px rgba(0,0,0,0.15);
}

.tab-buttons button.active {
    background-color: #667eea; /* Sfondo colorato per la tab attiva */
    color: white;
    font-weight: 600;
    border-color: #667eea;
    z-index: 2;
    transform: translateY(-1px); /* Solleva leggermente la tab attiva */
    box-shadow: 0 -3px 6px rgba(102, 126, 234, 0.3);
}

.tab-buttons button.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #667eea; /* Copre la linea di base sotto la tab attiva */
}
                
        .tab-content {
            padding: 30px;
            border: 2px solid #e0e0e0; /* Bordo coerente con la linea delle tab */
            border-top: none; /* Rimuovi il bordo superiore per un look "connesso" */
            border-radius: 0 0 15px 15px;
            background-color: white;
        }
        /* === FINE BLOCCO STILI TAB AGGIORNATO === */

        .kpi-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            margin-top: 20px;
        }
        
        .kpi-card {
            flex: 1;
            padding: 30px;
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .kpi-card.visitors {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .kpi-card.foreigners {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .kpi-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .kpi-value {
            font-size: 2.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .kpi-label {
            font-size: 1.5rem;
            opacity: 0.8;
        }
        
        .controls {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 20px;
    display: flex;
    gap: 20px;
    align-items: flex-end;
    flex-wrap: wrap;
}

.control-group {
    display: flex;
    flex-direction: column;
    flex: 1 1 200px;
}
        
        .control-group label {
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .control-group select {
            padding: 8px 12px;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            background: white;
        }
        
        .chart-container {
            background: linear-gradient(135deg, rgba(236, 240, 241, 0.8) 0%, rgba(195, 207, 226, 0.8) 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid #ccc;
        }
        .chart-with-tile {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .chart-section {
            flex: 1;
            min-width: 0; 
        }
        
        .local-tile {
            min-width: 250px;
            padding: 20px;
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            align-self: flex-start;
            margin-top: 50px;
        }
        
        .local-tile.italia {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .local-tile.emilia-romagna {
            background: linear-gradient(135deg, #3498db 0%, #5dade2 100%);
        }
        
        .local-tile.bologna-provincia {
            background: linear-gradient(135deg, #9b59b6 0%, #bb8fce 100%);
        }
        
        .local-tile.bologna-comune {
            background: linear-gradient(135deg, #e74c3c 0%, #ec7063 100%);
        }
        
        .local-tile-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .local-tile-value {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .local-tile-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .chart-canvas {
            height: 800px;
            width: 100%;
            max-height: 800px;
        }

        .chart-canvas-bar {
            height: 500px;
            width: 100%;
        }
        
        .status {
            text-align: center;
            font-style: italic;
            color: #2c3e50;
            font-size: 1.4rem;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .note {
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(155, 89, 182, 0.1) 100%);
            border-left: 5px solid #667eea;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
            font-style: italic;
            font-size: 1.4rem;
        }

        /* === STILI PER LA MAPPA === */
        .map-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        #worldMap {
            height: 600px;
            width: 100%;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        .map-stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .map-stat-card {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            min-width: 200px;
        }

        .map-stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .map-stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .map-legend {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }

        /* Popup personalizzato per la mappa */
        .popup-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .popup-stat {
            margin-bottom: 5px;
            color: #34495e;
        }

        .popup-number {
            font-weight: bold;
            color: #e74c3c;
        }

        /* === CONTRASTI DINAMICI TRA SEZIONI === */
.chart-container:nth-of-type(odd) {
  background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%) !important;
}
.chart-container:nth-of-type(even) {
  background: linear-gradient(135deg, #eef2f7 0%, #dbe9ff 100%) !important;
}

/* === ANIMAZIONI === */
.fade-in {
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.6s ease;
}
.fade-in.visible {
  opacity: 1;
  transform: translateY(0);
}

/* === INDICATORE CARICAMENTO ANIMATO === */
#status.loading::after {
  content: ' ‚≥π';
  animation: dots 1s steps(3, end) infinite;
}
@keyframes dots {
  0% { content: ' ‚≥π'; }
  33% { content: ' ‚≥π.'; }
  66% { content: ' ‚≥π..'; }
  100% { content: ' ‚≥π...'; }
}

    </style>
</head>
<body>
    <div class="header fade-in">
        <h1>üèõÔ∏è Dashboard Settore Musei Civici Bologna</h1>
        <p>Analisi delle provenienze dei visitatori dei musei bolognesi</p>
    </div>
    <div class="status loading" id="status">üì° Caricamento dati</div>

    <!-- BOTTONI TAB AGGIORNATI CON ICONE -->
    <div class="tab-buttons fade in">
      <button class="tab-link active" onclick="openTab(event, 'Panoramica')">üìä Panoramica</button>
      <button class="tab-link" onclick="openTab(event, 'Confronti')">üÜö Confronti</button> 
      <button class="tab-link" onclick="openTab(event, 'Top10')">üèÜ Top 10</button>
      <button class="tab-link" onclick="openTab(event, 'Mappa')">üó∫Ô∏è Mappa Mondiale</button>
    </div>

    <div id="Panoramica" class="tab-content" style="display:block;">
        <div class="kpi-container">
            <div class="kpi-card visitors">
                <div class="kpi-icon">üë•</div>
                <div class="kpi-value" id="totalVisitors">0</div>
                <div class="kpi-label">Visitatori Totali intervistati</div>
            </div>
            <div class="kpi-card foreigners">
                <div class="kpi-icon">üåç</div>
                <div class="kpi-value" id="foreignerPercent">0.0%</div>
                <div class="kpi-label">% Visitatori Stranieri</div>
            </div>
        </div>
        
        <div class="chart-container fade in">
  <div class="controls" style="margin-top: 20px;">
  <div class="control-group">
    <label for="annoTabellaSelect" style="color: white; font-weight: bold;">üìÖ Seleziona Anno</label>
    <select id="annoTabellaSelect" onchange="updateTable()"></select>
  </div>
  <div class="control-group">
    <label for="meseTabellaSelect" style="color: white; font-weight: bold;">üìÖ Seleziona Mese</label>
    <select id="meseTabellaSelect" onchange="updateTable()">
      <option value="Tutti">Tutti</option>
    </select>
  </div>
  <div class="control-group">
    <label for="tipoTabellaSelect" style="color: white; font-weight: bold;">üèõÔ∏è Tipo</label>
    <select id="tipoTabellaSelect" onchange="updateTable()">
      <option value="Tutti">Tutti (Musei + Mostre)</option>
      <option value="SoloMusei">Collezioni permanenti</option>
      <option value="SoloMostre">Mostre</option>
    </select>
  </div>
</div>
  <div id="summaryTableContainer">
    <!-- Tabella generata dinamicamente -->
  </div>
  

            <!-- RIGA SUPERIORE: SOLO ANNO -->
<div class="controls">
  <div class="control-group">
    <label for="annoSelect">üìÖ Seleziona Anno</label>
    <select id="annoSelect" onchange="onAnnoChange()"></select>
  </div>
</div>

<!-- RIGA SOTTOSTANTE: Mese, Museo, Mostra -->
<div class="controls">
  <div class="control-group">
    <label for="meseSelect">üìÖ Seleziona Mese</label>
    <select id="meseSelect" onchange="updateCharts()">
      <option value="Tutti">Tutti</option>
    </select>
  </div>
  <div class="control-group">
    <label for="museoSelect">üèõÔ∏è Seleziona Museo</label>
    <select id="museoSelect" onchange="updateCharts(); handleMuseumShowSelection('museo')">
      <option value="Tutti">Tutti</option>
    </select>
  </div>
  <div class="control-group">
    <label for="mostraSelect">üé® Seleziona Mostra</label>
    <select id="mostraSelect" onchange="updateCharts(); handleMuseumShowSelection('mostra')">
      <option value="Tutti">Tutti</option>
    </select>
  </div>
</div>
</div>

        <div class="chart-container">
            <canvas id="mainChart" class="chart-canvas"></canvas>
        </div>
        
        <div class="chart-container">
            <canvas id="foreignersChart" class="chart-canvas"></canvas>
            <div id="foreignersChartNote" class="chart-note"></div>
        </div>
        
        <div class="chart-container">
            <canvas id="timeChart" class="chart-canvas"></canvas>
        </div>
        <div class="note fade in" id="note"></div>
    </div>
  
    <div id="Confronti" class="tab-content" style="display:none;">
  <div class="header">
    <h2>üìà Confronti Annuali per Museo</h2>
  </div>

  <!-- üéõÔ∏è FILTRI -->
  <div class="controls fade in">
    <div class="control-group">
      <label for="annoBaseSelect">üìÖ Anno Base</label>
      <select id="annoBaseSelect" onchange="syncConfrontoConBase(); updateAnnualComparison()"></select>
    </div>
    <div class="control-group">
      <label for="annoConfrontoSelect">üìÖ Anno di Confronto</label>
      <select id="annoConfrontoSelect" onchange="updateAnnualComparison()"></select>
    </div>
    <div class="control-group">
      <label for="meseConfrontoSelect">üìÖ Mese</label>
      <select id="meseConfrontoSelect" onchange="updateAnnualComparison()">
        <option value="Tutti">Tutti</option>
      </select>
    </div>
    <div class="control-group">
      <label for="museoConfrontoSelect">üèõÔ∏è Museo</label>
      <select id="museoConfrontoSelect" onchange="updateAnnualComparison()">
        <option value="Tutti">Tutti</option>
      </select>
    </div>
  </div>

  <!-- üìã TABELLA COMPARATIVA -->
  <div id="comparisonTableContainer"></div>

  <!-- üìä GRAFICO -->
  <div class="chart-container">
    <canvas id="comparisonChart" class="chart-canvas-bar"></canvas>
  </div>
</div>

    <div id="Top10" class="tab-content" style="display:none;">
    <div class="header">
        <h2>üìä Classifiche TOP 10 mensili</h2>
    </div>

    <!-- Controlli unificati per questa scheda -->
    <div class="controls">
        <div class="control-group">
            <label for="meseGeoSelect">üìÖ Seleziona Mese</label>
            <select id="meseGeoSelect" onchange="updateGeographicCharts()"></select>
        </div>
        <div class="control-group">
            <label for="top10TypeSelect">üìà Seleziona Classifica</label>
            <select id="top10TypeSelect" onchange="updateGeographicCharts()">
                <option value="nazioni">Top 10 Nazioni</option>
                <option value="regioni">Top 10 Regioni Italiane</option>
                <option value="cittaEuropee">Top 10 Citt√† Europee</option>
                <option value="province">Top 10 Province Italiane</option>
                <option value="comuniCm">Top 10 Comuni della Citt√† Metropolitana</option>
            </select>
        </div>
    </div>

    <!-- Container unico per il grafico e il riquadro laterale -->
    <div class="chart-container">
        <div class="chart-with-tile">
            <div class="chart-section">
                 <canvas id="top10ChartCanvas" class="chart-canvas-bar"></canvas>
            </div>
            <!-- Questo riquadro √® ora dinamico e viene gestito da JavaScript -->
            <div id="top10Tile" class="local-tile" style="display: none;">
                <div class="local-tile-icon">üèõÔ∏è</div>
                <div class="local-tile-value" id="top10TileValue">0</div>
                <div class="local-tile-label" id="top10TileLabel"></div>
            </div>
         </div>
    </div>
</div>

    <!-- NUOVA TAB MAPPA -->
    <div id="Mappa" class="tab-content" style="display:none;">
        <div class="header">
            <h2>üó∫Ô∏è Mappa Mondiale dei Visitatori</h2>
            <p>Visualizzazione geografica interattiva delle provenienze</p>
        </div>

        <!-- Controlli per la mappa -->
        <div class="controls">
            <div class="control-group">
                <label for="annoMappaSelect">üìÖ Anno</label>
                <select id="annoMappaSelect" on